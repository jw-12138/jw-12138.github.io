---
import {getCollection, getEntry} from 'astro:content'

export async function getStaticPaths() {
  const allPosts = await getCollection('posts')
  return allPosts.map(post => {
    let date_str = post.slug
    let date_array = date_str.split('-')
    let year = date_array[0]
    let month = date_array[1]
    let day = date_array[2]
    let postPath = post.slug.slice(11)
    return {
      params: {
        slug: postPath,
        year: year,
        month: month,
        date: day
      },
      props: {
        entry: post
      }
    }
  })
}

const entry = await getEntry('posts', Astro.props.entry.slug)

let {body} = entry
const {Content, remarkPluginFrontmatter} = await entry.render()

let getPostTextCount = function () {
  let allText = body

  // remove all code fences like ```
  allText = allText.replace(/```[\s\S]*?```/g, '')

  let chineseCharCount = 0
  let englishCharCount = 0

  allText.split('').forEach((char) => {
    if (!!char.match(/\p{Script=Han}/u)) {
      chineseCharCount++
    }

    if (!!char.match(/[a-zA-Z]/)) {
      englishCharCount++
    }
  })

  return Math.ceil(englishCharCount / 5) + chineseCharCount
}

let wordsCount = getPostTextCount()

remarkPluginFrontmatter.wordsCount = wordsCount
---

<Content/>
